---
interface Props {
  title?: string;
  description?: string;
  buttonText?: string;
  leadMagnetName?: string;
}

const {
  title = 'Checklist Gratuito',
  description = '7 Erros que Matam sua Horta (e Como Evitar) - Baixe agora e salve suas plantas!',
  buttonText = 'Quero o Checklist',
  leadMagnetName = 'checklist-7-erros',
} = Astro.props;
---

<!-- Popup Overlay -->
<div
  id="lead-magnet-popup"
  class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
>
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full relative overflow-hidden">
    <!-- Close Button -->
    <button
      id="popup-close"
      class="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 transition-colors z-10"
      aria-label="Fechar"
    >
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Header Image -->
    <div class="bg-gradient-to-br from-primary-500 to-primary-700 p-8 text-center">
      <div class="w-16 h-16 mx-auto bg-white/20 rounded-full flex items-center justify-center mb-4">
        <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">{title}</h3>
      <p class="text-primary-100 text-sm">{description}</p>
    </div>

    <!-- Form -->
    <div class="p-6">
      <form id="popup-form" class="space-y-4">
        <input type="hidden" name="lead_magnet" value={leadMagnetName} />
        <div>
          <label for="popup-name" class="block text-sm font-medium text-gray-700 mb-1">
            Seu nome
          </label>
          <input
            type="text"
            id="popup-name"
            name="name"
            placeholder="Maria"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>
        <div>
          <label for="popup-email" class="block text-sm font-medium text-gray-700 mb-1">
            Seu melhor email
          </label>
          <input
            type="email"
            id="popup-email"
            name="email"
            placeholder="maria@email.com"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-primary-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-primary-700 transition-colors flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          {buttonText}
        </button>
        <p class="text-xs text-gray-500 text-center">
          Prometemos nao enviar spam. Voce pode cancelar quando quiser.
        </p>
      </form>

      <!-- Success Message -->
      <div id="popup-success" class="hidden text-center py-8">
        <div class="w-16 h-16 mx-auto bg-primary-100 rounded-full flex items-center justify-center mb-4">
          <svg class="w-8 h-8 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h4 class="text-xl font-bold text-gray-900 mb-2">Pronto!</h4>
        <p class="text-gray-600">Verifique seu email para baixar o checklist.</p>
      </div>
    </div>
  </div>
</div>

<script>
  const popup = document.getElementById('lead-magnet-popup');
  const closeBtn = document.getElementById('popup-close');
  const form = document.getElementById('popup-form') as HTMLFormElement;
  const successDiv = document.getElementById('popup-success');

  // Show popup after 30 seconds or 50% scroll
  let hasShownPopup = false;

  function showPopup() {
    if (hasShownPopup || localStorage.getItem('popup_shown')) return;
    hasShownPopup = true;
    popup?.classList.remove('hidden');
    popup?.classList.add('flex');
    localStorage.setItem('popup_shown', Date.now().toString());
  }

  // Timer trigger
  setTimeout(showPopup, 30000);

  // Scroll trigger
  window.addEventListener('scroll', () => {
    const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
    if (scrollPercent > 50) showPopup();
  });

  // Exit intent trigger (desktop only)
  document.addEventListener('mouseout', (e) => {
    if (e.clientY < 10) showPopup();
  });

  // Close popup
  closeBtn?.addEventListener('click', () => {
    popup?.classList.add('hidden');
    popup?.classList.remove('flex');
  });

  popup?.addEventListener('click', (e) => {
    if (e.target === popup) {
      popup.classList.add('hidden');
      popup.classList.remove('flex');
    }
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    try {
      const response = await fetch('/api/subscribe', {
        method: 'POST',
        body: JSON.stringify({
          name: formData.get('name'),
          email: formData.get('email'),
          lead_magnet: formData.get('lead_magnet'),
        }),
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        form.classList.add('hidden');
        successDiv?.classList.remove('hidden');
        localStorage.setItem('subscribed', 'true');
      }
    } catch (error) {
      console.error('Subscription error:', error);
    }
  });
</script>
